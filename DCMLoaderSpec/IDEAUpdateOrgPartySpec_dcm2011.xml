<?xml version="1.0" encoding="UTF-8"?>
<!--
This spec is used to update organization party into DCM, organization party page available under Party (Tab) - Search for Organization

Data File Format:
Tax ID,Name,Agency Formation Date,Role,Description,DBA,Organization Type,CRD Number,DTCCID,NPN,Party Role,Party Type,Renewal Fee Payee,Status Code,Status Start Date,Status End Date,User

Sample Data:
SA_123,Savvion_Aurea_Accolite_India Pvt Ltd,1/1/1950,APPOINTINGCOMPANY,Description,DBA 2,OrgType,SA_CRD_123,SA22,124578,Selling Agent,Compensation only,Distributor,Recontractable,1/1/2000,1/1/2020,sa

How to run:
ant LoadFile -Denvironment=DCM -DSPEC_FILE={File-Location}/InsertPersonPartySpec.xml -DDATA_FILE={File-Location}/InsertPersonPartyData.csv -DOUTPUT_DIR={Temp-Dir} -DBATCH_SIZE=100

-->
<loader:loader_spec
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:loader="http://dms.trilogy.com/Loader/Spec"
    xmlns="http://dms.trilogy.com/Loader/Spec"
    xsi:schemaLocation="http://dms.trilogy.com/Loader/Spec LoaderSpec.xsd"

    name="Update Org Parties Loader Spec"
    >

	<error_handlers>
		<handler name="idea_log_error_handler" class="log_message_error_handler">
			<property name="filename" value="${OUTPUT_DIR}/${ERROR_FILENAME}"/>
		</handler>
	</error_handlers>

	<strategy name="strategy" class="${STRATEGY}">
		<property name="memory.batch_size" value="${BATCH_SIZE}"/>
		<property name="exitIfSanityCheckFails" value="${SANITY_CHECK}"/>
	</strategy>

    <object name="org_party" class="OrgPartyStatusLoaderValidator"/>
	
    <source name="load_file" class="delimited_file_parser">
        <property name="filename" value="${FILENAME}"/>
        <property name="delimiters" value=","/>
        <property name="headerRows" value="1"/>
		<property name="quote_chars" value="&quot;"/>
		
		<indexed_field name="tax id" index="0"/>
		<indexed_field name="name" index="1"/>
        <indexed_field name="agency formation date" index="2" translator="date_translator"/>

        <indexed_field name="role" index="3" translator="role_translator"/>

		<indexed_field name="description" index="4"/>
		<indexed_field name="dba" index="5"/>
		<indexed_field name="organization type" index="6"/>

		<indexed_field name="crd number" index="7"/>
		<indexed_field name="dtcc id" index="8"/>
		<indexed_field name="npn" index="9"/>
        <indexed_field name="party role" index="10" translator="party_role_translator"/>
        <indexed_field name="party type" index="11" translator="party_type_translator"/>

        <indexed_field name="renewal fee payee" index="12" translator="renewal_fee_payee_translator"/>

		<indexed_field name="status code" index="13" translator="status_code_translator"/>
        <indexed_field name="status reason" index="14"/>
		<indexed_field name="status start date" index="15" translator="date_translator"/>
        <indexed_field name="status end date" index="16" translator="date_translator"/>

		<indexed_field name="usr" index="17"/>
		<indexed_field name="syncWithPDB" index="18" translator="boolean_translator"/>
		
    </source>
	
	<translator name="date_translator" class="date_format_translator">
		<property name="formatString" value="MM/dd/yyyy"/>
		<property name="treatEmptyAsNull" value="true"/>
	</translator>
	<translator name="role_translator" class="role_translator"/>
	<translator name="country_translator" class="enum_translator">
		<property name="enumName" value="COUNTRY"/>
	</translator>
	<translator name="party_role_translator" class="enum_translator">
		<property name="enumName" value="PartyRole"/>
	</translator>
	<translator name="party_type_translator" class="enum_translator">
		<property name="enumName" value="PartyType"/>
	</translator>
	<translator name="renewal_fee_payee_translator" class="enum_translator">
		<property name="enumName" value="RenewalFeePayee"/>
	</translator>
	<translator name="status_code_translator" class="enum_translator">
		<property name="enumName" value="Party.RecontractableStatus"/>
	</translator>
	<translator name="status_reason_translator" class="com.trilogy.fs.dms.tools.loader.translate.PartyStatusReasonTranslator">
		<property name="statusReasonBaseEnumName" value="Party.RecontractableStatus.Reason"/>
		<property name="statusEnumName" value="Party.RecontractableStatus"/>
	</translator>
	<translator name="boolean_translator" class="boolean_translator">
		<property name="true" value="true" />
		<property name="false" value="false" />
	</translator>

	<resolver name="user_resolver" class="batch_query_resolver">
		<property name="query">
			<![CDATA[
			SELECT usr FROM SCUser usr
					WHERE usr.LoginName = {0}
			]]>
		</property>
		<property name="keys" value="string userid"/>
	</resolver>

	<!--constant name="false constant" class="value">
		<property name="value" value="false"/>
	</constant-->
	
	<resolver name="party_resolver" class="batch_query_resolver">
		<property name="query">
			<![CDATA[
				SELECT party.GID g FROM FSParty party WHERE 
					(party.Party IN (SELECT org FROM SCOrganization org WHERE org.TaxID = {0}))
			]]>
		</property>
		<property name="keys" value="string TaxID"/>
	</resolver>

    <map object="org_party">
        <action name="update" resolver="party_resolver">
            <field name="tax id"/>
        </action>

		<map_simple property="Org.TaxID" field="tax id"/>
		<map_simple property="Org.Name" field="name"/>
        <map_simple property="Org.AgencyFormationDate" field="agency formation date"/>
		
		<map_simple property="Roles" field="role" tag="validator"/>
		
		<map_simple property="Org.Description" field="description"/>
		<map_simple property="Org.DBA" field="dba"/>
		<map_simple property="Org.OrganizationType" field="organization type"/>
		<!--map_simple property="Org.npn" field="npn"/-->

		<map_simple property="CRDNumber" field="crd number"/>
		<map_simple property="DTCCID" field="dtcc id"/>
        <map_simple property="PartyRole" field="party role"/>
        <map_simple property="PartyType" field="party type"/>

		<map_simple property="RenewalFeePayee" field="renewal fee payee"/>
		<map_simple property="SyncPDB" field="syncWithPDB"/>
        <map_simple property="NewStatus.StatusCode" field="status code" tag="validator"/>
		<map_merge property="NewStatus.StatusReason" tag="validator" translator="status_reason_translator">
			<field name="status code"/>
			<field name="status reason"/>
		</map_merge>
        <map_simple property="NewStatus.StartDate" field="status start date" tag="validator"/>
        <map_simple property="NewStatus.EndDate" field="status end date" tag="validator"/>

		<map_object property="SCUser" resolver="user_resolver">
			<field name="usr"/>
		</map_object>
    </map>

</loader:loader_spec>